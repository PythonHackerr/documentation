## Features used

- [iOS SDK](/sdk/ios)
- [Geofences](/geofences)

## Steps

### Step 1: Sign up for Radar

If you haven't already, sign up for Radar to get your API key. You can create up to 1,000 geofences and make up to 100,000 API requests per month for free.

<p> <a className="btn btn-large btn-primary" href="https://radar.com/signup">Get API Keys</a> </p>

### Step 2: Import geofences

On the [Geofences page](https://radar.com/dashboard), import geofences for RadarMart locations.

The CSV should include 8 columns:

- **`description`**: A display name for the geofence. In this case, the store name.
- **`tag`**: A group for the geofence. In this case, `store`.
- **`externalId`**: An external ID for the geofence that maps to your internal database. In this case, the store ID.
- **`type`**: The type of geofence geometry. In this case, `circle`.
- **`radius`**: The radius in meters for type circle. In this case, `100`.
- **`coordinates`**: A JSON string representing a center in the format [longitude,latitude] for type circle. Note that longitude comes before latitude, a GeoJSON convention.
- **`enabled`**: In this case, `true`.
- **`metadata`**: A set of custom key-value pairs for the geofence. A JSON string representing a dictionary with up to 16 keys and values of type string, boolean, or number. In this case, `{"parking": true}` or `{"parking": false}`.

```csv
description,tag,externalId,type,radius,coordinates,enabled,metadata
RadarMart #1,store,1,circle,100,"[-73.986752,40.703919]",true,"{""parking"":true}"
RadarMart #2,store,2,circle,100,"[-73.993156,40.700554]",true,"{""parking"":false}"
RadarMart #3,store,3,circle,100,"[-73.983295,40.697693]",true,"{""parking"":false}"
```

### Step 3: Install the Radar iOS SDK

[Install the Radar SDK](/sdk/ios).

Initialize the SDK in your `AppDelegate` class with your publishable API key and request `When In Use` location permissions. You must add location usage strings to the custom iOS Target Properties found in the Info tab of the app settings. 

To request foreground permissions in the app, add a new property with the key `NSLocationWhenInUseUsageDescription` (_Privacy - Location When In Use Usage Description_). The value is displayed in the location permission prompts. Enter a message such as `Your location will be used to personalize in app experiences`.

```swift
import UIKit
import RadarSDK

@UIApplicationMain
class AppDelegate: UIResponder, UIApplicationDelegate, CLLocationManagerDelegate {

    let locationManager = CLLocationManager()

    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        Radar.initialize(publishableKey: "prj_test_pk...")
        self.locationManager.delegate = self
        return true
    }

    func locationManager(_ manager: CLLocationManager, didChangeAuthorization status: CLAuthorizationStatus) {
        self.requestLocationPermissions()
    }

    func requestLocationPermissions() {
        let status = locationManager.authorizationStatus

        if status == .notDetermined {
            self.locationManager.requestWhenInUseAuthorization()
        }
    }
}
```

### Step 4: Check if the user is in a geofence, then change the UI

Call `Radar.trackOnce()` to track the user's location in the foreground. In the callback, check `user.geofences` to determine if the user is in a geofence, then show a message and default to the in-store tab.

```swift
Radar.trackOnce { (status, location, events, user) in
    if let isInStore = user?.geofences?.contains(where: { $0.tag == "store" }) {
        if isInStore {
            self.showInStoreMode(user: user)
        }
    }
}
```

The `showInStoreMode()` method in this tutorial will trigger a UI alert that redirects the user to an In Store Mode ViewController. The geofence `description` and `externalId` attributes will be used to dynamically set information relevant to the specific store detected in the in store mode view.

See the github repository linked at the top of the tutorial for a full code implementation.

```swift
class ViewController: UITabBarController {
    
    let tabInStore = TabInStoreViewController()

    ...

    func showInStoreMode(user: RadarUser?) {
        var storeDescription = "RadarMart"
        var storeId: String?
        if let geofenceDescription = user?.geofences?.first(where: { $0.tag == "store" })?.__description {
            storeDescription = geofenceDescription
        }
        if let geofenceExternalId = user?.geofences?.first(where: { $0.tag == "store" })?.externalId {
            storeId = geofenceExternalId
        }
        let confirmAction = UIAlertAction(
            title: "OK", style: UIAlertAction.Style.default) { (action) in
                self.selectedIndex = 1
                self.tabInStore.inStoreTitle.text = storeDescription
                if (storeId != nil) {
                    self.tabInStore.inStoreSubtitle.text = "Store #: \(String(describing: storeId))"
                }
        }
        
        let alertController = UIAlertController(title: "Welcome to \(storeDescription)!", message: nil, preferredStyle: .alert)
        alertController.addAction(confirmAction)
        self.present(alertController, animated: true, completion: nil)
    }
```

### Step 5: Verify in store mode triggers when in a geofence.

Either simulate location on your phone or adjust the geofence location to your testing device's location. When you open the app, verify the in store mode triggers when in a geofence, but not when outside the geofence.  You should also see a user record appear on the Users page of the Radar dashboard with the detected geofences.

![In Store Mode Verification](/gif/tutorials/in-store-mode/verify_in_store_mode_ios.gif)

## Support

Have questions or feedback on this documentation? Let us know! Email us at [support@radar.com](mailto:support@radar.com).
